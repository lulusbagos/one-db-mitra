@model IReadOnlyList<one_db_mitra.Models.Admin.KaryawanListItem>
@using System
@using System.Linq
@using System.Security.Claims
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Data Karyawan";
    var activeOnly = ViewBag.ActiveOnly as bool? ?? true;
    var activeCount = ViewBag.ActiveCount as int? ?? 0;
    var nonActiveCount = ViewBag.NonActiveCount as int? ?? 0;
    var isOwner = ViewBag.IsOwner as bool? ?? false;
    var companyOptions = ViewBag.CompanyOptions as IEnumerable<SelectListItem> ?? Enumerable.Empty<SelectListItem>();
    var userId = User.FindFirstValue(ClaimTypes.NameIdentifier) ?? "0";
    int? lockCompanyId = ViewBag.LockCompanyId as int?;
    int? lockDepartmentId = ViewBag.LockDepartmentId as int?;
    int? lockSectionId = ViewBag.LockSectionId as int?;
    int? lockPositionId = ViewBag.LockPositionId as int?;

    string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1) return parts[0][0].ToString().ToUpperInvariant();
        return (parts[0][0].ToString() + parts[^1][0].ToString()).ToUpperInvariant();
    }

    string GetAvatarTone(string name)
    {
        var tones = new[] { "emerald", "teal", "cyan", "sky", "blue", "indigo", "violet" };
        if (string.IsNullOrWhiteSpace(name)) return "secondary";
        return tones[name[0] % tones.Length];
    }
}

<div class="karyawan-header">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 text-white">
        <div>
            <span class="badge karyawan-badge mb-2">
                <i class="bi bi-people me-2"></i>Manajemen Karyawan
            </span>
            <h2 class="mb-1 fw-bold">Data Karyawan</h2>
            <p class="mb-0 text-white-50">Kelola profil, penempatan, dan dokumen karyawan.</p>
        </div>
        <div class="d-flex gap-2 align-items-end flex-wrap">
            <div class="text-end">
                <div class="text-uppercase small text-white-50">Aktif</div>
                <div class="fs-4 fw-semibold" id="karyawanActiveCount">@activeCount</div>
            </div>
            <div class="text-end">
                <div class="text-uppercase small text-white-50">Nonaktif</div>
                <div class="fs-4 fw-semibold" id="karyawanNonActiveCount">@nonActiveCount</div>
            </div>
            <a class="btn btn-outline-light fw-semibold" asp-action="DownloadTemplate">
                <i class="bi bi-download me-2"></i>Template Excel
            </a>
            <a class="btn btn-outline-light fw-semibold" asp-action="ExportExcel" asp-route-activeOnly="@activeOnly" id="karyawanExportLink">
                <i class="bi bi-file-earmark-spreadsheet me-2"></i>Export Excel
            </a>
            <button class="btn btn-light fw-semibold" data-bs-toggle="modal" data-bs-target="#importExcelModal">
                <i class="bi bi-upload me-2"></i>Import Excel
            </button>
            <a class="btn btn-light fw-semibold" asp-action="Create">
                <i class="bi bi-plus-lg me-2"></i>Tambah Karyawan
            </a>
        </div>
    </div>
</div>

<div class="container-fluid px-0 karyawan-body">
    <div class="card shadow-sm border-0 rounded-4 mb-4">
        <div class="card-body d-flex flex-wrap gap-3 align-items-center">
            <div class="stat-pill" data-bs-toggle="tooltip" data-bs-title="Total karyawan aktif dalam scope akses.">
                <span class="stat-label">Aktif</span>
                <span class="stat-value" id="statActiveCount">@activeCount</span>
            </div>
            <div class="stat-pill" data-bs-toggle="tooltip" data-bs-title="Total karyawan nonaktif dalam scope akses.">
                <span class="stat-label">Nonaktif</span>
                <span class="stat-value" id="statNonActiveCount">@nonActiveCount</span>
            </div>
            <div class="stat-pill stat-danger" data-bs-toggle="tooltip" data-bs-title="Karyawan dengan status blacklist aktif.">
                <span class="stat-label">Blacklist</span>
                <span class="stat-value" id="statBlacklistCount">0</span>
            </div>
            <div class="stat-pill stat-safety" data-bs-toggle="tooltip" data-bs-title="Karyawan dengan pelanggaran Safety.">
                <span class="stat-label">Safety</span>
                <span class="stat-value" id="statSafetyCount">0</span>
            </div>
            <div class="stat-pill stat-hr" data-bs-toggle="tooltip" data-bs-title="Karyawan dengan pelanggaran HR.">
                <span class="stat-label">HR</span>
                <span class="stat-value" id="statHrCount">0</span>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 rounded-4 mb-4">
        <div class="card-body d-flex flex-column flex-lg-row gap-3 align-items-start align-items-lg-center">
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="karyawanActiveOnly" value="true" @(activeOnly ? "checked" : null) />
                    <label class="form-check-label" for="karyawanActiveOnly">Tampilkan aktif saja</label>
                </div>
                <span class="badge @(activeOnly ? "text-bg-success" : "text-bg-secondary")" id="activeFilterBadge">
                    @(activeOnly ? "Filter: Aktif" : "Filter: Semua")
                </span>
            </div>
            <div class="d-flex gap-2 ms-lg-auto flex-wrap">
                <div class="input-group input-group-sm karyawan-search">
                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="karyawanSearch" placeholder="Cari nama, NIK, email..." />
                </div>
                <select class="form-select form-select-sm karyawan-filter js-company-select"
                        id="karyawanCompanyFilter"
                        data-placeholder="Semua Perusahaan"
                        @(lockCompanyId.HasValue && lockCompanyId.Value > 0 ? "disabled" : null)>
                    <option value="">Semua Perusahaan</option>
                    @foreach (var option in companyOptions)
                    {
                        if (option.Selected)
                        {
                            <option value="@option.Value" selected="selected">@option.Text</option>
                        }
                        else
                        {
                            <option value="@option.Value">@option.Text</option>
                        }
                    }
                </select>
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#karyawanAdvancedFilters">
                    <i class="bi bi-sliders me-1"></i>Advanced
                </button>
            </div>
        </div>
    </div>

    <div class="collapse mb-4" id="karyawanAdvancedFilters">
        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Departemen</label>
                        <select class="form-select form-select-sm" id="karyawanDepartmentFilter" @(lockDepartmentId.HasValue && lockDepartmentId.Value > 0 ? "disabled" : null)>
                            <option value="">Semua</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Section</label>
                        <select class="form-select form-select-sm" id="karyawanSectionFilter" @(lockSectionId.HasValue && lockSectionId.Value > 0 ? "disabled" : null)>
                            <option value="">Semua</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Jabatan</label>
                        <select class="form-select form-select-sm" id="karyawanPositionFilter" @(lockPositionId.HasValue && lockPositionId.Value > 0 ? "disabled" : null)>
                            <option value="">Semua</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select class="form-select form-select-sm" id="karyawanStatusFilter">
                            <option value="">Semua</option>
                            <option value="active">Aktif</option>
                            <option value="nonaktif">Nonaktif</option>
                            <option value="blacklist">Blacklist</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tanggal Masuk (From)</label>
                        <input type="date" class="form-control form-control-sm" id="karyawanDateFrom" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tanggal Masuk (To)</label>
                        <input type="date" class="form-control form-control-sm" id="karyawanDateTo" />
                    </div>
                    <div class="col-md-6 d-flex gap-2 justify-content-end">
                        <button class="btn btn-outline-secondary btn-sm" type="button" id="karyawanResetFilters">Reset</button>
                        <button class="btn btn-primary btn-sm" type="button" id="karyawanSaveFilters">Simpan Filter</button>
                    </div>
                </div>
                <div class="text-secondary small mt-2">
                    Filter disimpan per user dan otomatis diterapkan saat membuka halaman.
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
        <div class="table-responsive kendo-host position-relative">
            <div class="karyawan-loading d-none" id="karyawanLoading">
                <div class="loading-card">
                    <div class="spinner-grow text-teal mb-3" role="status"></div>
                    <div class="fw-semibold">Memuat data karyawan...</div>
                    <div class="progress mt-3">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="karyawanProgressBar"></div>
                    </div>
                    <div class="small text-secondary mt-2" id="karyawanProgressText">0%</div>
                </div>
            </div>
            <table class="table table-hover align-middle mb-0 karyawan-table">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">Profil</th>
                        <th>Kontak</th>
                        <th>Posisi</th>
                        <th>Departemen</th>
                        <th>Status & Dokumen</th>
                        <th class="text-center pe-4">Aksi</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="p-3 border-top bg-white">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="text-secondary small" id="karyawanSummary">
                    Menampilkan data terbaru.
                </div>
                <div id="karyawanPager"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="nonaktifModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nonaktifModalTitle">Nonaktifkan Karyawan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="Nonaktifkan" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <input type="hidden" name="id" id="nonaktifKaryawanId" />
                    <div class="alert alert-warning small mb-3">
                        Nonaktif memerlukan alasan. Blacklist hanya bisa dibuka kembali oleh Owner.
                    </div>
                    <div class="nonaktif-section">
                        <div class="section-title">
                            <i class="bi bi-shield-exclamation"></i>
                            <span>Status & Alasan</span>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <select name="statusType" class="form-select" id="nonaktifStatusType">
                                    <option value="nonaktif">Nonaktif</option>
                                    @if (isOwner)
                                    {
                                        <option value="blacklist">Blacklist</option>
                                    }
                                    else
                                    {
                                        <option value="blacklist" disabled>Blacklist</option>
                                    }
                                </select>
                                @if (!isOwner)
                                {
                                    <div class="text-secondary small mt-1">Blacklist hanya tersedia untuk Owner.</div>
                                }
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Kategori</label>
                                <select name="kategori" class="form-select">
                                    <option value="Resign">Resign</option>
                                    <option value="Pelanggaran">Pelanggaran</option>
                                    <option value="Lainnya">Lainnya</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Alasan</label>
                                <textarea name="alasan" class="form-control" rows="3" placeholder="Tuliskan alasan..." required></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="nonaktif-section mt-4">
                        <div class="section-title">
                            <i class="bi bi-exclamation-octagon"></i>
                            <span>Pelanggaran (Opsional)</span>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Jenis</label>
                                <select name="pelanggaranJenis" class="form-select">
                                    <option value="">- Pilih -</option>
                                    <option value="Safety">Safety</option>
                                    <option value="HR">HR</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tanggal</label>
                                <input type="date" name="pelanggaranTanggal" class="form-control" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Keterangan</label>
                                <input type="text" name="pelanggaranKeterangan" class="form-control" placeholder="Ringkasan pelanggaran" />
                            </div>
                        </div>
                        <div class="text-secondary small mt-2">
                            Dicatat sebagai status pelanggaran (Safety/HR) dan tampil di detail karyawan.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-danger">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="importExcelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Karyawan (Excel)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="ImportPreview" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <p class="text-secondary small mb-2">
                        Unduh template terlebih dahulu, lalu isi dan upload kembali.
                    </p>
                    <input type="file" name="file" class="form-control" accept=".xlsx" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" />
    <style>
        .karyawan-header {
            background: linear-gradient(135deg, #064e3b 0%, #0ea5a5 100%);
            padding: 2rem 2.5rem 4rem;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 15px 35px rgba(6, 78, 59, 0.35);
            margin-bottom: -2rem;
            position: relative;
            z-index: 1;
        }
        .karyawan-badge {
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 999px;
            padding: 0.35rem 0.9rem;
        }

        .karyawan-body {
            position: relative;
            z-index: 2;
        }

        .karyawan-table th {
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.04em;
            color: #64748b;
            font-weight: 700;
        }

        .karyawan-avatar {
            width: 52px;
            height: 52px;
            border-radius: 16px;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
        }

        .karyawan-avatar-initial {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1rem;
        }

        .bg-soft-emerald { background-color: #d1fae5; }
        .text-emerald-700 { color: #047857; }
        .border-emerald-100 { border-color: #d1fae5 !important; }

        .bg-soft-teal { background-color: #ccfbf1; }
        .text-teal { color: #0f766e; }
        .bg-soft-cyan { background-color: #cffafe; }
        .text-cyan { color: #0891b2; }
        .bg-soft-sky { background-color: #e0f2fe; }
        .text-sky { color: #0284c7; }
        .bg-soft-blue { background-color: #dbeafe; }
        .text-blue { color: #2563eb; }
        .bg-soft-indigo { background-color: #e0e7ff; }
        .text-indigo { color: #4f46e5; }
        .bg-soft-violet { background-color: #ede9fe; }
        .text-violet { color: #7c3aed; }

        .karyawan-search {
            min-width: 220px;
        }

        .karyawan-filter {
            min-width: 200px;
        }

        .hierarchy-badges .badge {
            font-size: 0.6rem;
            letter-spacing: 0.02em;
        }

        .karyawan-loading {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.92);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .loading-card {
            text-align: center;
            background: #ffffff;
            border-radius: 16px;
            padding: 1.5rem 2rem;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
            min-width: 240px;
        }

        .nonaktif-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 1rem 1.25rem;
        }

        .nonaktif-section .section-title {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #0f172a;
        }

        .nonaktif-section .section-title i {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: rgba(14, 165, 165, 0.15);
            color: #0f766e;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .stat-pill {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 999px;
            padding: 0.4rem 0.9rem;
            font-size: 0.85rem;
        }

        .stat-pill .stat-label {
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-size: 0.7rem;
            color: #64748b;
            font-weight: 700;
        }

        .stat-pill .stat-value {
            font-size: 1rem;
            font-weight: 700;
            color: #0f172a;
        }

        .stat-pill.stat-danger {
            background: #fee2e2;
            border-color: #fecaca;
        }

        .stat-pill.stat-safety {
            background: #ffe4e6;
            border-color: #fecdd3;
        }

        .stat-pill.stat-hr {
            background: #dbeafe;
            border-color: #bfdbfe;
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script>
        const nonaktifModal = document.getElementById('nonaktifModal');
        if (nonaktifModal) {
            nonaktifModal.addEventListener('show.bs.modal', (event) => {
                const button = event.relatedTarget;
                const id = button?.getAttribute('data-id') || '';
                const name = button?.getAttribute('data-name') || '';
                const nik = button?.getAttribute('data-nik') || '';
                const title = document.getElementById('nonaktifModalTitle');
                const inputId = document.getElementById('nonaktifKaryawanId');
                if (title) {
                    title.textContent = `Nonaktifkan ${name} (${nik})`;
                }
                if (inputId) {
                    inputId.value = id;
                }
            });
        }

        window.karyawanHelpers = {
            getInitials: (name) => {
                if (!name) return "?";
                const parts = name.trim().split(" ");
                if (parts.length === 1) return parts[0][0].toUpperCase();
                return `${parts[0][0]}${parts[parts.length - 1][0]}`.toUpperCase();
            },
            getAvatarTone: (name) => {
                const tones = ["emerald", "teal", "cyan", "sky", "blue", "indigo", "violet"];
                if (!name) return "secondary";
                return tones[name.charCodeAt(0) % tones.length];
            }
        };

        const progressBar = document.getElementById("karyawanProgressBar");
        const progressText = document.getElementById("karyawanProgressText");
        const loadingOverlay = document.getElementById("karyawanLoading");
        let progressTimer = null;
        const lockCompanyId = "@(lockCompanyId?.ToString() ?? "")";
        const lockDepartmentId = "@(lockDepartmentId?.ToString() ?? "")";
        const lockSectionId = "@(lockSectionId?.ToString() ?? "")";
        const lockPositionId = "@(lockPositionId?.ToString() ?? "")";

        const setLoading = (isLoading) => {
            if (!loadingOverlay) return;
            if (isLoading) {
                loadingOverlay.classList.remove("d-none");
                let progress = 0;
                if (progressTimer) clearInterval(progressTimer);
                progressTimer = setInterval(() => {
                    progress = Math.min(progress + Math.random() * 12, 90);
                    if (progressBar) progressBar.style.width = `${Math.round(progress)}%`;
                    if (progressText) progressText.textContent = `${Math.round(progress)}%`;
                }, 180);
            } else {
                if (progressTimer) clearInterval(progressTimer);
                if (progressBar) progressBar.style.width = "100%";
                if (progressText) progressText.textContent = "100%";
                setTimeout(() => loadingOverlay.classList.add("d-none"), 400);
            }
        };

        const activeSwitch = document.getElementById("karyawanActiveOnly");
        const companyFilter = document.getElementById("karyawanCompanyFilter");
        const searchInput = document.getElementById("karyawanSearch");
        const departmentFilter = document.getElementById("karyawanDepartmentFilter");
        const sectionFilter = document.getElementById("karyawanSectionFilter");
        const positionFilter = document.getElementById("karyawanPositionFilter");
        const statusFilter = document.getElementById("karyawanStatusFilter");
        const dateFromFilter = document.getElementById("karyawanDateFrom");
        const dateToFilter = document.getElementById("karyawanDateTo");
        const activeBadge = document.getElementById("activeFilterBadge");
        const summary = document.getElementById("karyawanSummary");
        const activeCountEl = document.getElementById("karyawanActiveCount");
        const nonActiveCountEl = document.getElementById("karyawanNonActiveCount");
        const exportLink = document.getElementById("karyawanExportLink");
        const statActive = document.getElementById("statActiveCount");
        const statNonActive = document.getElementById("statNonActiveCount");
        const statBlacklist = document.getElementById("statBlacklistCount");
        const statSafety = document.getElementById("statSafetyCount");
        const statHr = document.getElementById("statHrCount");

        const applyLockValue = (select, value) => {
            if (!select) return;
            if (value) {
                select.value = value;
                select.setAttribute("disabled", "disabled");
            } else {
                select.removeAttribute("disabled");
            }
        };

        const table = $(".karyawan-table").DataTable({
            serverSide: true,
            processing: true,
            searching: false,
            lengthChange: false,
            pageLength: 20,
            dom: "tp",
            ajax: {
                url: "/KaryawanAdmin/Data",
                data: function (d) {
                    d.activeOnly = activeSwitch?.checked || false;
                    d.companyId = companyFilter?.value || "";
                    d.departmentId = departmentFilter?.value || "";
                    d.sectionId = sectionFilter?.value || "";
                    d.positionId = positionFilter?.value || "";
                    d.statusType = statusFilter?.value || "";
                    d.dateFrom = dateFromFilter?.value || "";
                    d.dateTo = dateToFilter?.value || "";
                    d.search = searchInput?.value || "";
                },
                dataSrc: function (json) {
                    if (summary) {
                        summary.textContent = `Total: ${json.recordsFiltered ?? json.total} | Aktif: ${json.activeCount} | Nonaktif: ${json.nonActiveCount}`;
                    }
                    if (activeCountEl) {
                        activeCountEl.textContent = json.activeCount ?? 0;
                    }
                    if (nonActiveCountEl) {
                        nonActiveCountEl.textContent = json.nonActiveCount ?? 0;
                    }
                    if (statActive) statActive.textContent = json.activeCount ?? 0;
                    if (statNonActive) statNonActive.textContent = json.nonActiveCount ?? 0;
                    if (statBlacklist) statBlacklist.textContent = json.blacklistCount ?? 0;
                    if (statSafety) statSafety.textContent = json.safetyCount ?? 0;
                    if (statHr) statHr.textContent = json.hrCount ?? 0;
                    if (activeBadge) {
                        const active = !!(activeSwitch?.checked);
                        activeBadge.className = `badge ${active ? "text-bg-success" : "text-bg-secondary"}`;
                        activeBadge.textContent = active ? "Filter: Aktif" : "Filter: Semua";
                    }
                    return json.data || [];
                }
            },
            columns: [
                {
                    data: null,
                    render: function (data) {
                        const initials = window.karyawanHelpers.getInitials(data.namaLengkap);
                        const tone = window.karyawanHelpers.getAvatarTone(data.namaLengkap);
                        const photo = data.photoUrl
                            ? `<img src="${data.photoUrl}" alt="Foto" class="karyawan-avatar" />`
                            : `<div class="karyawan-avatar karyawan-avatar-initial bg-soft-${tone} text-${tone}">${initials}</div>`;
                        const badges = [];
                        if (data.hierarchyOwner) {
                            badges.push(`<span class="badge text-bg-primary">Owner: ${data.hierarchyOwner}</span>`);
                        }
                        if (data.hierarchyLevel >= 1 && data.hierarchyMainContractor) {
                            badges.push(`<span class="badge text-bg-info">Main: ${data.hierarchyMainContractor}</span>`);
                        }
                        if (data.hierarchyLevel >= 2 && data.hierarchySubContractor) {
                            badges.push(`<span class="badge text-bg-warning">Sub: ${data.hierarchySubContractor}</span>`);
                        }
                        if (data.hierarchyLevel >= 3 && data.hierarchyVendor) {
                            badges.push(`<span class="badge text-bg-secondary">Vendor: ${data.hierarchyVendor}</span>`);
                        }
                        const hierarchyHtml = badges.length
                            ? `<div class="d-flex flex-wrap gap-1 mt-2 hierarchy-badges">${badges.join("")}</div>`
                            : "";
                        return `
                            <div class="d-flex align-items-center gap-3">
                                ${photo}
                                <div>
                                    <div class="fw-semibold text-dark">${data.namaLengkap}</div>
                                    <div class="text-secondary small d-flex flex-wrap gap-2">
                                        <span><i class="bi bi-person-badge me-1"></i>${data.noNik}</span>
                                        <span><i class="bi bi-building me-1"></i>${data.companyName}</span>
                                    </div>
                                    ${hierarchyHtml}
                                </div>
                            </div>
                        `;
                    }
                },
                {
                    data: null,
                    render: function (data) {
                        const email = data.email || "-";
                        const phone = data.phone || "-";
                        return `<div class="small text-dark fw-semibold">${email}</div><div class="text-secondary small">${phone}</div>`;
                    }
                },
                {
                    data: "positionName",
                    render: function (data) {
                        return `<div class="fw-semibold text-dark">${data || "-"}</div>`;
                    }
                },
                {
                    data: null,
                    render: function (data) {
                        return `
                            <span class="badge bg-soft-emerald text-emerald-700 border border-emerald-100 rounded-pill px-3 py-2">
                                ${data.departmentName || "-"}
                            </span>
                            <div class="text-secondary small mt-1">${data.sectionName || "-"}</div>
                        `;
                    }
                },
                {
                    data: null,
                    render: function (data) {
                        const statusBadge = data.isActive
                            ? '<span class="badge text-bg-success">Aktif</span>'
                            : '<span class="badge text-bg-secondary">Nonaktif</span>';
                        let statusTag = "";
                        if (data.statusLabel) {
                            const tone = data.statusType === "blacklist"
                                ? "text-bg-dark"
                                : data.statusType === "pelanggaran"
                                    ? "text-bg-danger"
                                    : data.statusLabel === "Resign"
                                        ? "text-bg-warning"
                                        : "text-bg-secondary";
                            statusTag = `<span class="badge ${tone}">${data.statusLabel}</span>`;
                        }
                        return `
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                ${statusBadge}
                                ${statusTag}
                                <span class="badge text-bg-light"><i class="bi bi-paperclip me-1"></i>${data.documentCount}</span>
                            </div>
                        `;
                    }
                },
                {
                    data: null,
                    orderable: false,
                    render: function (data) {
                        const disable = data.isActive ? "" : "disabled";
                        const nonaktifButton = data.isActive
                            ? `
                                <button class="btn btn-sm btn-outline-danger"
                                        data-bs-toggle="modal"
                                        data-bs-target="#nonaktifModal"
                                        data-id="${data.karyawanId}"
                                        data-name="${data.namaLengkap}"
                                        data-nik="${data.noNik}">
                                    <i class="bi bi-slash-circle"></i>
                                </button>
                              `
                            : `
                                <button class="btn btn-sm btn-outline-secondary" ${disable}>
                                    <i class="bi bi-slash-circle"></i>
                                </button>
                              `;
                        return `
                            <div class="d-flex justify-content-center gap-2">
                                <a class="btn btn-sm btn-outline-primary" href="/KaryawanAdmin/Detail/${data.karyawanId}">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a class="btn btn-sm btn-outline-secondary" href="/KaryawanAdmin/Edit/${data.karyawanId}">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                ${nonaktifButton}
                            </div>
                        `;
                    }
                }
            ],
            language: {
                processing: "Memuat...",
                emptyTable: "Belum ada data karyawan."
            },
            drawCallback: function () {
                $("#karyawanPager").empty().append($(".dataTables_paginate"));
                $(".dataTables_paginate").addClass("pagination-sm");
                document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((el) => {
                    if (!el._tooltip) {
                        el._tooltip = new bootstrap.Tooltip(el);
                    }
                });
            }
        });

        let searchTimer = null;
        const triggerSearch = () => {
            if (searchTimer) clearTimeout(searchTimer);
            searchTimer = setTimeout(() => table.ajax.reload(), 350);
        };

        if (searchInput) {
            searchInput.addEventListener("input", triggerSearch);
        }
        if (companyFilter) {
            companyFilter.addEventListener("change", () => table.ajax.reload());
        }
        if (departmentFilter) {
            departmentFilter.addEventListener("change", () => table.ajax.reload());
        }
        if (sectionFilter) {
            sectionFilter.addEventListener("change", () => table.ajax.reload());
        }
        if (positionFilter) {
            positionFilter.addEventListener("change", () => table.ajax.reload());
        }
        if (statusFilter) {
            statusFilter.addEventListener("change", () => table.ajax.reload());
        }
        if (dateFromFilter) {
            dateFromFilter.addEventListener("change", () => table.ajax.reload());
        }
        if (dateToFilter) {
            dateToFilter.addEventListener("change", () => table.ajax.reload());
        }
        if (activeSwitch) {
            activeSwitch.addEventListener("change", () => table.ajax.reload());
        }

        const updateExportLink = () => {
            if (!exportLink) return;
            const base = exportLink.getAttribute("data-base-url") || exportLink.href;
            const url = new URL(base, window.location.origin);
            url.searchParams.set("activeOnly", activeSwitch?.checked ? "true" : "false");
            exportLink.href = url.toString();
        };

        if (exportLink && !exportLink.getAttribute("data-base-url")) {
            exportLink.setAttribute("data-base-url", exportLink.href.split("?")[0]);
        }

        if (activeSwitch) {
            activeSwitch.addEventListener("change", updateExportLink);
        }

        updateExportLink();

        const filterKey = `karyawanFilters_${@userId}`;
        const saveFilters = () => {
            const payload = {
                search: searchInput?.value || "",
                companyId: companyFilter?.value || "",
                departmentId: departmentFilter?.value || "",
                sectionId: sectionFilter?.value || "",
                positionId: positionFilter?.value || "",
                statusType: statusFilter?.value || "",
                dateFrom: dateFromFilter?.value || "",
                dateTo: dateToFilter?.value || "",
                activeOnly: activeSwitch?.checked || false
            };
            localStorage.setItem(filterKey, JSON.stringify(payload));
            showToast("Filter disimpan untuk user ini.", "success");
        };

        const applyFilters = (payload) => {
            if (!payload) return;
            if (searchInput) searchInput.value = payload.search || "";
            if (companyFilter) companyFilter.value = lockCompanyId || payload.companyId || "";
            if (departmentFilter) departmentFilter.value = lockDepartmentId || payload.departmentId || "";
            if (sectionFilter) sectionFilter.value = lockSectionId || payload.sectionId || "";
            if (positionFilter) positionFilter.value = lockPositionId || payload.positionId || "";
            if (statusFilter) statusFilter.value = payload.statusType || "";
            if (dateFromFilter) dateFromFilter.value = payload.dateFrom || "";
            if (dateToFilter) dateToFilter.value = payload.dateTo || "";
            if (activeSwitch) activeSwitch.checked = !!payload.activeOnly;
            applyLockValue(companyFilter, lockCompanyId);
            applyLockValue(departmentFilter, lockDepartmentId);
            applyLockValue(sectionFilter, lockSectionId);
            applyLockValue(positionFilter, lockPositionId);
        };

        const savedFilters = localStorage.getItem(filterKey);
        if (savedFilters) {
            try {
                applyFilters(JSON.parse(savedFilters));
            } catch { }
        } else {
            applyFilters({});
        }

        const saveButton = document.getElementById("karyawanSaveFilters");
        const resetButton = document.getElementById("karyawanResetFilters");
        if (saveButton) {
            saveButton.addEventListener("click", () => {
                saveFilters();
                table.ajax.reload();
            });
        }
        if (resetButton) {
            resetButton.addEventListener("click", () => {
                localStorage.removeItem(filterKey);
                applyFilters({});
                table.ajax.reload();
            });
        }

        async function loadDepartments(companyId) {
            if (!departmentFilter) return;
            const selectedDepartmentId = lockDepartmentId || departmentFilter.value || "";
            departmentFilter.innerHTML = '<option value="">Semua</option>';
            sectionFilter.innerHTML = '<option value="">Semua</option>';
            positionFilter.innerHTML = '<option value="">Semua</option>';
            if (!companyId) return;
            const response = await fetch(`/KaryawanAdmin/DepartmentsByCompany?companyId=${companyId}`);
            const data = await response.json();
            data.forEach(item => {
                const opt = document.createElement("option");
                opt.value = item.id;
                opt.textContent = item.name;
                departmentFilter.appendChild(opt);
            });
            if (selectedDepartmentId) {
                departmentFilter.value = selectedDepartmentId;
            }
            applyLockValue(departmentFilter, lockDepartmentId);
        }

        async function loadSections(deptId) {
            if (!sectionFilter) return;
            const selectedSectionId = lockSectionId || sectionFilter.value || "";
            sectionFilter.innerHTML = '<option value="">Semua</option>';
            positionFilter.innerHTML = '<option value="">Semua</option>';
            if (!deptId) return;
            const response = await fetch(`/KaryawanAdmin/SectionsByDepartment?departmentId=${deptId}`);
            const data = await response.json();
            data.forEach(item => {
                const opt = document.createElement("option");
                opt.value = item.id;
                opt.textContent = item.name;
                sectionFilter.appendChild(opt);
            });
            if (selectedSectionId) {
                sectionFilter.value = selectedSectionId;
            }
            applyLockValue(sectionFilter, lockSectionId);
        }

        async function loadPositions(sectionId) {
            if (!positionFilter) return;
            const selectedPositionId = lockPositionId || positionFilter.value || "";
            positionFilter.innerHTML = '<option value="">Semua</option>';
            if (!sectionId) return;
            const response = await fetch(`/KaryawanAdmin/PositionsBySection?sectionId=${sectionId}`);
            const data = await response.json();
            data.forEach(item => {
                const opt = document.createElement("option");
                opt.value = item.id;
                opt.textContent = item.name;
                positionFilter.appendChild(opt);
            });
            if (selectedPositionId) {
                positionFilter.value = selectedPositionId;
            }
            applyLockValue(positionFilter, lockPositionId);
        }

        companyFilter?.addEventListener("change", () => loadDepartments(companyFilter.value));
        departmentFilter?.addEventListener("change", () => loadSections(departmentFilter.value));
        sectionFilter?.addEventListener("change", () => loadPositions(sectionFilter.value));

        if (companyFilter?.value) {
            loadDepartments(companyFilter.value).then(() => {
                if (departmentFilter?.value) {
                    loadSections(departmentFilter.value).then(() => {
                        if (sectionFilter?.value) {
                            loadPositions(sectionFilter.value);
                        }
                    });
                }
            });
        }

        $(".karyawan-table").on("processing.dt", function (_e, _settings, processing) {
            setLoading(processing);
        });
    </script>
}
