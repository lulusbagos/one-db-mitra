@model IReadOnlyList<one_db_mitra.Models.Admin.PengajuanPerusahaanListItem>
@{
    ViewData["Title"] = "Pengajuan Perusahaan";
    var canSubmit = (bool?)ViewBag.CanSubmit ?? false;
    var isOwner = (bool?)ViewBag.IsOwner ?? false;
}

<div class="container-fluid px-0">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
        <div>
            <p class="text-uppercase text-secondary small mb-1">Pengajuan</p>
            <h2 class="mb-1">Pengajuan Perusahaan</h2>
            <p class="text-secondary mb-0">Lengkapi dokumen, tunggu review Safety, dan pantau progres.</p>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center">
            @if (canSubmit)
            {
                <a class="btn btn-primary" asp-action="Create">
                    <i class="bi bi-plus-lg me-2"></i>Ajukan Perusahaan
                </a>
            }
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="text-secondary small">Menunggu Review</div>
                    <div class="fs-4 fw-semibold">@((int?)ViewBag.PendingCount ?? 0)</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="text-secondary small">Perlu Perbaikan</div>
                    <div class="fs-4 fw-semibold">@((int?)ViewBag.NeedFixCount ?? 0)</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="text-secondary small">Disetujui</div>
                    <div class="fs-4 fw-semibold">@((int?)ViewBag.ApprovedCount ?? 0)</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="text-secondary small">Ditolak</div>
                    <div class="fs-4 fw-semibold">@((int?)ViewBag.RejectedCount ?? 0)</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Daftar Pengajuan</h6>
            <span class="badge text-bg-light border">@Model.Count pengajuan</span>
        </div>
        <div class="card-body table-responsive">
            <table class="table table-striped align-middle mb-0">
                <thead>
                    <tr>
                        <th>Kode</th>
                        <th>Perusahaan</th>
                        <th>Email</th>
                        <th>Tipe</th>
                        <th>Status</th>
                        <th>Dibuat</th>
                        <th>SLA</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Count == 0)
                    {
                        <tr>
                            <td colspan="7" class="text-center text-secondary py-4">Belum ada pengajuan.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in Model)
                        {
                            var badge = item.StatusPengajuan switch
                            {
                                "approved" => "text-bg-success",
                                "approved_remark" => "text-bg-warning",
                                "ditolak" => "text-bg-danger",
                                "perlu_perbaikan" => "text-bg-warning",
                                "review_akhir" => "text-bg-info",
                                "menunggu_dokumen" => "text-bg-secondary",
                                "pengajuan_awal" => "text-bg-secondary",
                                _ => "text-bg-secondary"
                            };
                            var statusLabel = item.StatusPengajuan switch
                            {
                                "pengajuan_awal" => "Pengajuan Awal",
                                "menunggu_dokumen" => "Menunggu Dokumen",
                                "review_akhir" => "Review Ulang",
                                "perlu_perbaikan" => "Perlu Perbaikan",
                                "approved" => "Disetujui",
                                "approved_remark" => "Disetujui (Remark)",
                                "ditolak" => "Ditolak",
                                _ => item.StatusPengajuan
                            };
                            var dueAt = item.CreatedAt.AddDays(3);
                            var slaLeft = (int)Math.Ceiling((dueAt - DateTime.UtcNow).TotalDays);
                            var slaText = slaLeft >= 0 ? $"{slaLeft} hari" : "Lewat";
                            var slaBadge = slaLeft >= 1 ? "text-bg-success"
                                : slaLeft == 0 ? "text-bg-warning"
                                : "text-bg-danger";

                            <tr>
                                <td class="fw-semibold">@item.KodePengajuan</td>
                                <td>
                                    <div class="fw-semibold">@item.NamaPerusahaan</div>
                                    @if (item.DokumenBelumLengkap)
                                    {
                                        <div class="small text-danger">Data belum lengkap</div>
                                    }
                                </td>
                                <td>@item.EmailPerusahaan</td>
                                <td>@item.TipePerusahaan</td>
                                <td>
                                    <span class="badge @badge">@statusLabel</span>
                                </td>
                                <td>
                                    <div class="small text-secondary">@item.CreatedAt.ToString("dd MMM yyyy")</div>
                                </td>
                                <td>
                                    <span class="badge @slaBadge">SLA @slaText</span>
                                </td>
                                <td class="text-end">
                                    <a class="btn btn-sm btn-outline-primary" asp-action="UploadDokumen" asp-route-id="@item.PengajuanId">Detail</a>
                                    @if (isOwner)
                                    {
                                        <a class="btn btn-sm btn-outline-success" asp-action="Review" asp-route-id="@item.PengajuanId">Review</a>
                                    }
                                    @if (canSubmit && !isOwner)
                                    {
                                        <form asp-action="Delete" asp-route-id="@item.PengajuanId" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    onclick="return confirm('Hapus pengajuan ini?');">
                                                Hapus
                                            </button>
                                        </form>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
